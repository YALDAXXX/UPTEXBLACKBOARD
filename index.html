<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPTEX Classroom</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fuente Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilo base */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Ocultar scrollbar pero permitir scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-rose-50">

    <!-- Contenedor principal de la aplicación -->
    <div id="app-container" class="min-h-screen">
        <!-- El contenido se renderizará aquí -->
    </div>

    <!-- Contenedor para modales -->
    <div id="modal-container">
        <!-- Los modales se renderizarán aquí -->
    </div>

    <!-- Contenedor para notificaciones -->
    <div id="notification-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-sm text-center">
            <h3 class="text-lg font-medium text-gray-900 mb-4" id="notification-title">¡Éxito!</h3>
            <p class="text-sm text-gray-600 mb-6" id="notification-message">Tu acción se completó correctamente.</p>
            <button data-action="close-notification" class="w-full bg-rose-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow hover:bg-rose-600 transition-colors">
                Cerrar
            </button>
        </div>
    </div>


    <!-- Script principal de la aplicación -->
    <script type="module">
        
        // ========================================================================
        // --- ESTADO DE LA APLICACIÓN (AQUÍ PUEDES EDITAR EL CONTENIDO) ---
        // ========================================================================
        let appState = {
            currentView: 'dashboard', // 'dashboard', 'subject', 'task', 'grades'
            currentSubjectId: null,
            currentTaskId: null,
            subjects: [
                { 
                    id: 'calc', 
                    name: 'Cálculo Diferencial Aplicado', 
                    professor: 'Profesor Gallegos', 
                    
                    // -----------------------------------------------------------------
                    // --- EDITAR AQUÍ: Agrega tareas para Cálculo ---
                    // -----------------------------------------------------------------
                    // Copia y pega este bloque para agregar más tareas.
                    // Cambia el 'id', 'title', y 'description'.
                    tasks: [
                        /*
                        { 
                            id: 't1_calc', 
                            title: 'Tarea 1: Límites', 
                            description: 'Resolver los ejercicios 1-10 del libro.', 
                            comments: [
                                { by: 'professor', text: 'Recuerden revisar las notas de clase.' }
                            ],
                            submission: { submitted: false, grade: null, feedback: null }
                        }
                        */
                    ], 
                    
                    // --- EDITAR AQUÍ: Edita el mensaje de bienvenida de Cálculo ---
                    messages: [
                        { by: 'professor', text: 'Bienvenidos a la materia. Pronto les subiré el contenido. El link de las clases, les avisaré qué día y hora será la sesión.' }
                    ]
                },
                { 
                    id: 'com', 
                    name: 'Comunicación Oral y Escrita', 
                    professor: 'Profesora Mirella', 
                    tasks: [],
                    messages: [] 
                },
                { 
                    id: 'ges', 
                    name: 'Gestión para los Negocios', 
                    professor: 'Profesora Nancy', 
                    tasks: [],
                    messages: [] 
                },
                { 
                    id: 'alg', 
                    name: 'Álgebra Universitaria Aplicada a Robots', 
                    professor: 'Profesora Adriana L', 
                    
                    // -----------------------------------------------------------------
                    // --- EDITAR AQUÍ: Agrega tareas para Álgebra ---
                    // -----------------------------------------------------------------
                    tasks: [], 
                    
                    // --- EDITAR AQUÍ: Edita el mensaje de bienvenida de Álgebra ---
                    messages: [
                        { by: 'professor', text: 'Bienvenidos a la materia. Pronto les subiré el contenido. El link de las clases, les avisaré qué día y hora será la sesión.' }
                    ] 
                },
                { 
                    id: 'herr', 
                    name: 'Herramientas Tecnológicas', 
                    professor: 'Profesora Yamani', 
                    
                    // -----------------------------------------------------------------
                    // --- EDITAR AQUÍ: Agrega tareas para Herramientas ---
                    // -----------------------------------------------------------------
                    tasks: [],
                    
                    // --- EDITAR AQUÍ: Edita el mensaje de bienvenida de Herramientas ---
                    messages: [
                        { by: 'professor', text: 'Bienvenidos a la materia. Pronto les subiré el contenido. El link de las clases, les avisaré qué día y hora será la sesión.' }
                    ]
                },
            ],
            globalAnnouncements: [
                { id: 'a1', text: 'SE INICIA EL SEGUNDO BLOQUE DEL NOVENO CUATRIMESTRE REVISA TUS MATERIAS Y REALIZA TUS TAREAS EN TIEMPO Y FORMA' }
            ]
        };
        // ========================================================================
        // --- FIN DEL ESTADO DE LA APLICACIÓN ---
        // ========================================================================


        const appContainer = document.getElementById('app-container');
        const modalContainer = document.getElementById('modal-container');
        const notificationModal = document.getElementById('notification-modal');
        const notificationTitle = document.getElementById('notification-title');
        const notificationMessage = document.getElementById('notification-message');

        // --- FUNCIONES DE RENDERIZADO ---

        /**
         * Renderiza la aplicación completa basado en el estado
         */
        function renderApp() {
            // Limpiar contenedores
            appContainer.innerHTML = '';
            modalContainer.innerHTML = '';

            // Renderizar header
            appContainer.innerHTML += renderHeader();

            // Renderizar vista actual
            const mainContent = document.createElement('main');
            mainContent.className = 'p-4 max-w-5xl mx-auto';
            
            // Lógica de pestañas para Dashboard y Calificaciones
            if (appState.currentView === 'dashboard' || appState.currentView === 'grades') {
                mainContent.innerHTML = renderNavigationTabs(); // Pestañas
                if (appState.currentView === 'dashboard') {
                    mainContent.innerHTML += renderDashboard();
                } else {
                    mainContent.innerHTML += renderGradesView(); // Nueva vista
                }
            } else if (appState.currentView === 'subject') {
                mainContent.innerHTML = renderSubjectView();
            } else if (appState.currentView === 'task') {
                mainContent.innerHTML = renderTaskView();
            }
            
            appContainer.appendChild(mainContent);

            // Renderizar modales (siempre están en el DOM, pero ocultos)
            modalContainer.innerHTML = renderModals();
            
            // Scroll al final del chat si la vista es 'subject'
            if (appState.currentView === 'subject') {
                setTimeout(() => {
                    const chatWindow = document.getElementById('chat-window');
                    if (chatWindow) {
                        chatWindow.scrollTop = chatWindow.scrollHeight;
                    }
                }, 0);
            }
        }

        /**
         * Renderiza el encabezado (simplificado, sin toggle)
         */
        function renderHeader() {
            return `
                <header class="bg-rose-600 shadow-md p-4">
                    <div class="max-w-5xl mx-auto flex justify-between items-center">
                        <h1 class="text-xl sm:text-2xl font-bold text-white">UPTEX</h1>
                        <!-- Botón de cambio de modo eliminado -->
                    </div>
                </header>
            `;
        }

        /**
         * Renderiza las pestañas de navegación principal (Materias y Calificaciones)
         */
        function renderNavigationTabs() {
            const isDashboard = appState.currentView === 'dashboard';
            const isGrades = appState.currentView === 'grades';

            // Clases para estilo de pestañas activas e inactivas
            const activeClass = 'border-rose-500 text-rose-600';
            const inactiveClass = 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';

            return `
                <div class="mb-6 border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button data-action="view-dashboard-main" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${isDashboard ? activeClass : inactiveClass}">
                            Mis Materias
                        </button>
                        <button data-action="view-grades" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${isGrades ? activeClass : inactiveClass}">
                            Calificaciones
                        </button>
                    </nav>
                </div>
            `;
        }


        /**
         * Renderiza el Dashboard (Anuncios y Materias)
         */
        function renderDashboard() {
            // HTML para Anuncios
            let announcementsHtml = appState.globalAnnouncements.map(ann => `
                <div class="bg-rose-100 border-l-4 border-rose-400 text-rose-800 p-4 rounded-r-lg mb-3">
                    <p class="text-sm">${ann.text}</p>
                </div>
            `).join('');

            if (appState.globalAnnouncements.length === 0) {
                announcementsHtml = `<p class="text-sm text-gray-500 italic">No hay anuncios por el momento.</p>`;
            }

            // HTML para Materias
            let subjectsHtml = appState.subjects.map(sub => {
                const isLocked = sub.id === 'com' || sub.id === 'ges';
                
                if (isLocked) {
                    // Plantilla para materias bloqueadas
                    return `
                    <div class="bg-gray-200 rounded-lg shadow p-4 opacity-70 cursor-not-allowed">
                        <h3 class="text-lg font-semibold text-gray-500 truncate">${sub.name}</h3>
                        <p class="text-sm text-gray-400">${sub.professor}</p>
                        <div class="mt-2 flex justify-between items-center">
                            <span class="text-xs font-medium text-gray-600 bg-gray-300 px-2 py-0.5 rounded-full">Bloqueado</span>
                            
                            <!-- 
                              --- EDITAR AQUÍ: Cambia la calificación de las materias bloqueadas --- 
                            -->
                            <span class="text-sm font-semibold text-green-600">Calificación: 9</span>
                        </div>
                    </div>
                    `;
                } else {
                    // Plantilla para materias activas
                    return `
                    <div data-action="view-subject" data-id="${sub.id}" class="bg-white rounded-lg shadow p-4 cursor-pointer transition duration-300 hover:shadow-lg hover:ring-2 hover:ring-rose-400">
                        <h3 class="text-lg font-semibold text-rose-700 truncate">${sub.name}</h3>
                        <p class="text-sm text-gray-600">${sub.professor}</p>
                        <div class="mt-2 flex justify-between items-center">
                            <span class="text-xs font-medium text-rose-600 bg-rose-100 px-2 py-0.5 rounded-full">${sub.tasks.length} tareas</span>
                        </div>
                    </div>
                    `;
                }
            }).join('');

            return `
                <!-- Sección de Anuncios -->
                <section class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-semibold text-rose-800">Anuncios</h2>
                        <!-- Botón de '+' eliminado -->
                    </div>
                    <div class="bg-white rounded-lg shadow p-4">
                        ${announcementsHtml}
                    </div>
                </section>

                <!-- Sección de Materias -->
                <section>
                    <h2 class="text-xl font-semibold text-rose-800 mb-3">Mis Materias</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${subjectsHtml}
                    </div>
                </section>
            `;
        }

        /**
         * Renderiza la vista de Calificaciones
         */
        function renderGradesView() {
            // 1. Recopilar todas las tareas de todas las materias
            let allTasks = [];
            appState.subjects.forEach(sub => {
                if (sub.id !== 'com' && sub.id !== 'ges') {
                    sub.tasks.forEach(task => {
                        allTasks.push({
                            ...task,
                            subjectName: sub.name,
                            subjectId: sub.id
                        });
                    });
                }
            });

            // 2. Filtrar solo las tareas entregadas
            const submittedTasks = allTasks.filter(t => t.submission.submitted);

            if (submittedTasks.length === 0) {
                return `
                    <h2 class="text-xl font-semibold text-rose-800 mb-3">Calificaciones</h2>
                    <p class="text-sm text-gray-500 italic">Aún no has entregado tareas.</p>
                `;
            }

            // 3. Renderizar la lista
            let tasksHtml = submittedTasks.map(task => {
                const grade = task.submission.grade;
                const status = grade ? 
                    `<span class="text-sm font-bold text-green-600">${grade}</span>` : 
                    `<span class="text-sm font-medium text-blue-600">Entregada</span>`;
                
                return `
                    <li class="bg-white rounded-lg shadow p-4 flex justify-between items-center">
                        <div>
                            <h4 class="text-md font-semibold text-rose-700">${task.title}</h4>
                            <p class="text-sm text-gray-600">${task.subjectName}</p>
                        </div>
                        <div class="text-right flex items-center space-x-4">
                            <div class="flex flex-col items-end">
                                <span class="text-xs text-gray-500 mb-1">Calificación</span>
                                ${status}
                            </div>
                            <!-- Botón de 'Calificar' eliminado -->
                        </div>
                    </li>
                `;
            }).join('');

            return `
                <h2 class="text-xl font-semibold text-rose-800 mb-3">Calificaciones</h2>
                <ul class="space-y-3">
                    ${tasksHtml}
                </ul>
            `;
        }

        /**
         * Renderiza la vista de una Materia (Tareas)
         */
        function renderSubjectView() {
            const subject = appState.subjects.find(s => s.id === appState.currentSubjectId);
            if (!subject) return `<p>Materia no encontrada.</p>`;

            // Renderizado de Tareas
            let tasksHtml = subject.tasks.map(task => {
                let taskStatus = '';
                 if (task.submission?.submitted) {
                    taskStatus = task.submission.grade 
                        ? `<span class="text-xs text-green-600 font-medium">Calificada (${task.submission.grade})</span>` 
                        : `<span class="text-xs text-blue-600 font-medium">Entregada</span>`;
                }

                return `
                <div data-action="view-task" data-subject-id="${subject.id}" data-task-id="${task.id}" class="bg-white rounded-lg shadow p-4 flex justify-between items-center cursor-pointer transition duration-300 hover:shadow-md hover:bg-gray-50">
                    <div>
                        <h4 class="text-md font-semibold text-rose-700">${task.title}</h4>
                        <p class="text-sm text-gray-600 truncate">${task.description}</p>
                    </div>
                    <div class="text-right">
                        ${taskStatus}
                        <span class="text-sm text-gray-400 ml-2">&gt;</span>
                    </div>
                </div>
                `;
            }).join('');

            if (subject.tasks.length === 0) {
                tasksHtml = `<p class="text-sm text-gray-500 italic">No hay tareas asignadas para esta materia.</p>`;
            }

            // Renderizado de Mensajes
            let messagesHtml = (subject.messages || []).map(msg => {
                const isProfessorMsg = msg.by === 'professor';
                return `
                    <div class="flex ${isProfessorMsg ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[70%] p-3 rounded-lg ${isProfessorMsg ? 'bg-rose-100 text-rose-900' : 'bg-gray-200 text-gray-900'}">
                            <p class="text-sm">${msg.text}</p>
                        </div>
                    </div>
                `;
            }).join('');

            if ((subject.messages || []).length === 0) {
                messagesHtml = `<p class="text-sm text-gray-400 italic text-center">No hay mensajes.</p>`;
            }

            return `
                <button data-action="view-dashboard-main" class="text-sm text-rose-500 hover:underline mb-4">&larr; Volver a Materias</button>
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-rose-800">${subject.name}</h2>
                        <p class="text-md text-gray-600">${subject.professor}</p>
                    </div>
                </div>

                <!-- Sección de Tareas -->
                <section>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl font-semibold text-rose-800">Tareas</h3>
                        <!-- Botón de '+' eliminado -->
                    </div>
                    <div class="space-y-3">
                        ${tasksHtml}
                    </div>
                </section>
                
                <!-- Sección de Mensajes (Chat) -->
                <section class="mt-8">
                    <h3 class="text-xl font-semibold text-rose-800 mb-3">Mensajes de la Materia</h3>
                    <!-- Ventana de Chat -->
                    <div id="chat-window" class="bg-white rounded-lg shadow p-4 h-64 overflow-y-auto space-y-3 no-scrollbar">
                        ${messagesHtml}
                    </div>
                    <!-- Formulario de Envío -->
                    <form id="subject-message-form" class="mt-4 flex space-x-2">
                        <input id="subject-message-text" type="text" placeholder="Escribe un mensaje..." class="flex-1 border border-gray-300 rounded-lg p-2 text-sm">
                        <button data-action="send-subject-message" type="button" class="bg-rose-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow hover:bg-rose-600">
                            Enviar
                        </button>
                    </form>
                </section>
            `;
        }

        /**
         * Renderiza la vista de una Tarea (Descripción y Comentarios)
         */
        function renderTaskView() {
            const subject = appState.subjects.find(s => s.id === appState.currentSubjectId);
            const task = subject?.tasks.find(t => t.id === appState.currentTaskId);

            if (!task) return `<p>Tarea no encontrada.</p>`;

            // Renderizar comentarios generales (solo de profesor)
            let commentsHtml = (task.comments || []).filter(c => c.by === 'professor').map(comment => `
                <div class="p-3 rounded-lg bg-rose-100 text-rose-800">
                    <span class="font-bold text-sm capitalize">Profesor</span>
                    <p class="text-sm">${comment.text}</p>
                </div>
            `).join('');

            // Renderizar sección de entrega (Alumno)
            let submissionHtml = '';
            const sub = task.submission;
            if (!sub.submitted) {
                submissionHtml = `
                    <div class="flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0">
                        <button data-action="open-modal" data-modal-id="submitTaskModal" class="flex-1 bg-rose-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow hover:bg-rose-600 transition-colors">
                            Entregar Tarea
                        </button>
                        <button data-action="open-modal" data-modal-id="sendMessageModal" class="flex-1 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300 transition-colors">
                            Enviar Mensaje a Profesor
                        </button>
                    </div>
                `;
            } else {
                submissionHtml = `
                    <h4 class="text-md font-semibold text-gray-700 mb-3">Tu Entrega</h4>
                    <div class="bg-gray-100 p-4 rounded-lg space-y-3">
                        <div>
                            <span class="text-sm font-medium text-gray-600">Estado:</span>
                            <span class="text-sm text-blue-600 font-semibold ml-2">Entregada</span>
                        </div>
                        ${sub.grade ? `
                        <div>
                            <span class="text-sm font-medium text-gray-600">Calificación:</span>
                            <span class="text-sm text-black font-bold ml-2">${sub.grade}</span>
                        </div>
                        ` : ''}
                        ${sub.feedback ? `
                        <div>
                            <span class="text-sm font-medium text-gray-600 d-block mb-1">Retroalimentación del Profesor:</span>
                            <p class="text-sm text-gray-800 bg-white p-3 rounded-md mt-1">${sub.feedback}</p>
                        </div>
                        ` : ''}
                        ${!sub.grade ? `
                        <p class="text-sm text-gray-500 italic">Tu tarea está pendiente de calificación.</p>
                        ` : ''}
                    </div>
                    <button data-action="open-modal" data-modal-id="sendMessageModal" class="mt-4 w-full bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300 transition-colors">
                        Enviar Mensaje a Profesor
                    </button>
                `;
            }

            return `
                <button data-action="back-subject" class="text-sm text-rose-500 hover:underline mb-4">&larr; Volver a ${subject.name}</button>
                
                <!-- Descripción de Tarea -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-2xl font-bold text-rose-800 mb-2">${task.title}</h2>
                    <p class="text-gray-700 mb-6">${task.description}</p>
                    
                    <!-- Contenido dinámico (Entrega Alumno) -->
                    ${submissionHtml}
                </div>

                <!-- Sección de Comentarios/Anuncios de Tarea -->
                <section>
                    <h3 class="text-xl font-semibold text-rose-800 mb-3">Comentarios del Profesor</h3>
                    
                    <!-- Formulario de Profesor eliminado -->

                    <!-- Lista de Comentarios -->
                    <div class="space-y-3">
                        ${commentsHtml}
                        ${(task.comments || []).filter(c => c.by === 'professor').length === 0 ? `<p class="text-sm text-gray-500 italic">No hay comentarios.</p>` : ''}
                    </div>
                </section>
                
                <!-- Sección de Calificación (Profesor) eliminada -->
            `;
        }

        /**
         * Renderiza todos los modales (solo de alumno)
         */
        function renderModals() {
            return `
                <!-- Modal: Entrega de Tarea (Alumno) -->
                <div id="submitTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-md">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Entregar Tarea</h3>
                        <p class="text-sm text-gray-600 mb-4">Sube tu archivo para completar la entrega.</p>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" class="text-sm">
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button data-action="close-modal" data-modal-id="submitTaskModal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300">Cancelar</button>
                            <button data-action="submit-task" class="bg-rose-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow hover:bg-rose-600">Entregar</button>
                        </div>
                    </div>
                </div>

                <!-- Modal: Enviar Mensaje (Alumno) -->
                <div id="sendMessageModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-md">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Enviar Mensaje al Profesor</h3>
                        <textarea id="message-text" class="w-full border border-gray-300 rounded-lg p-2 text-sm" rows="5" placeholder="Escribe tu mensaje privado..."></textarea>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button data-action="close-modal" data-modal-id="sendMessageModal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300">Cancelar</button>
                            <button data-action="send-message" class="bg-rose-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow hover:bg-rose-600">Enviar</button>
                        </div>
                    </div>
                </div>
                
                <!-- Modales de profesor eliminados -->
            `;
        }

        // --- FUNCIONES DE LÓGICA Y EVENTOS ---

        function showView(view, subjectId = null, taskId = null) {
            appState.currentView = view;
            appState.currentSubjectId = subjectId;
            appState.currentTaskId = taskId;
            
            // Limpiar IDs si volvemos a las vistas principales
            if (view === 'dashboard' || view === 'grades') {
                appState.currentSubjectId = null;
                appState.currentTaskId = null;
            }
            
            renderApp();
            window.scrollTo(0, 0); // Regresar al top
        }

        function openModal(modalId) {
            // Re-renderizar modales
            modalContainer.innerHTML = renderModals();
            document.getElementById(modalId)?.classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId)?.classList.add('hidden');
        }

        function showNotification(title, message) {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            notificationModal.classList.remove('hidden');
        }

        // Lógica de profesor eliminada

        function handleSubmitTask() {
            const task = appState.subjects
                .find(s => s.id === appState.currentSubjectId)?.tasks
                .find(t => t.id === appState.currentTaskId);
            
            if (task) {
                // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                // NOTA: ESTE CAMBIO ES TEMPORAL. 
                // Si cierras la página, se perderá. 
                // Para hacerlo permanente, edita el `appState` arriba.
                // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                task.submission.submitted = true; 
            }
            
            closeModal('submitTaskModal');
            showNotification('¡Tarea Entregada!', 'Tu tarea ha sido enviada.');
            renderApp(); // Re-renderizar para mostrar estado "Entregada"
        }

        function handleSendMessage() {
            const text = document.getElementById('message-text').value;
            if (text.trim()) {
                document.getElementById('message-text').value = '';
                closeModal('sendMessageModal');
                showNotification('¡Mensaje Enviado!', 'Tu mensaje ha sido enviado al profesor.');
            }
        }
        
        /**
         * Maneja el envío de un mensaje en el chat de la materia
         */
        function handleSendSubjectMessage() {
            const text = document.getElementById('subject-message-text').value;
            const subject = appState.subjects.find(s => s.id === appState.currentSubjectId);

            if (text.trim() && subject) {
                if (!subject.messages) {
                    subject.messages = [];
                }
                // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                // NOTA: ESTE CAMBIO ES TEMPORAL. 
                // Si cierras la página, se perderá.
                // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                subject.messages.push({
                    by: 'student', // Siempre 'student' ahora
                    text: text.trim()
                });
                document.getElementById('subject-message-text').value = '';
                renderApp(); // Re-renderiza la vista de materia
            }
        }

        // Lógica de calificación eliminada

        // --- MANEJADOR PRINCIPAL DE EVENTOS (DELEGACIÓN) ---

        document.body.addEventListener('click', function(e) {
            // Usar 'closest' para encontrar el elemento con data-action
            const target = e.target.closest('[data-action]');
            if (!target) return;

            // Prevenir clics en elementos dentro de un contenedor bloqueado
            if (target.closest('.cursor-not-allowed')) {
                return;
            }

            const action = target.dataset.action;
            const modalId = target.dataset.modalId;

            switch (action) {
                // Acciones de pestañas principales
                case 'view-dashboard-main':
                    showView('dashboard');
                    break;
                case 'view-grades':
                    showView('grades');
                    break;
                // Acciones de navegación
                case 'view-subject':
                    showView('subject', target.dataset.id);
                    break;
                case 'view-task':
                    showView('task', target.dataset.subjectId, target.dataset.taskId);
                    break;
                case 'back-dashboard':
                    showView('dashboard');
                    break;
                case 'back-subject':
                    showView('subject', appState.currentSubjectId);
                    break;
                // Acciones de Modales
                case 'open-modal':
                    openModal(modalId);
                    break;
                case 'close-modal':
                    closeModal(modalId);
                    break;
                case 'close-notification':
                    notificationModal.classList.add('hidden');
                    break;
                // Acciones de Lógica (solo alumno)
                case 'submit-task':
                    handleSubmitTask();
                    break;
                case 'send-message':
                    handleSendMessage();
                    break;
                case 'send-subject-message':
                    handleSendSubjectMessage();
                    break;
            }
        });

        // --- INICIALIZACIÓN ---
        renderApp();

    </script>
</body>
</html>
