<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPTEX Classroom</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fuente Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilo base */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Estilos para el toggle pequeño */
        .toggle-bg:after {
            content: '';
            @apply absolute top-[2px] left-[2px] bg-white border border-gray-300 rounded-full h-3 w-3 transition-transform duration-300 ease-in-out;
        }
        
        input:checked + .toggle-bg:after {
            @apply translate-x-[10px]; /* Ajustado para el nuevo tamaño w-7 */
        }
        
        input:checked + .toggle-bg {
            @apply bg-rose-600;
        }

        /* Ocultar scrollbar pero permitir scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-rose-50">

    <!-- Contenedor principal de la aplicación -->
    <div id="app-container" class="min-h-screen">
        <!-- El contenido se renderizará aquí -->
    </div>

    <!-- Contenedor para modales -->
    <div id="modal-container">
        <!-- Los modales se renderizarán aquí -->
    </div>

    <!-- Contenedor para notificaciones -->
    <div id="notification-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-sm text-center">
            <h3 class="text-lg font-medium text-gray-900 mb-4" id="notification-title">¡Éxito!</h3>
            <p class="text-sm text-gray-600 mb-6" id="notification-message">Tu acción se completó correctamente.</p>
            <button data-action="close-notification" class="w-full bg-rose-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow hover:bg-rose-600 transition-colors">
                Cerrar
            </button>
        </div>
    </div>


    <!-- Script principal de la aplicación -->
    <script type="module">
        // Estado inicial de la aplicación
        let appState = {
            mode: 'professor', // 'professor' o 'student'
            currentView: 'dashboard', // 'dashboard', 'subject', 'task', 'grades'
            currentSubjectId: null,
            currentTaskId: null,
            subjects: [
                { 
                    id: 'calc', 
                    name: 'Cálculo Diferencial Aplicado', 
                    professor: 'Profesor Gallegos', 
                    tasks: [], // Tareas vaciadas
                    messages: [] // Sección de chat añadida
                },
                { 
                    id: 'com', 
                    name: 'Comunicación Oral y Escrita', 
                    professor: 'Profesora Mirella', 
                    tasks: [],
                    messages: [] // Sección de chat añadida
                },
                { 
                    id: 'ges', 
                    name: 'Gestión para los Negocios', 
                    professor: 'Profesora Nancy', 
                    tasks: [],
                    messages: [] // Sección de chat añadida
                },
                { 
                    id: 'alg', 
                    name: 'Álgebra Universitaria Aplicada a Robots', 
                    professor: 'Profesora Adriana L', 
                    tasks: [], // Tareas vaciadas
                    messages: [] // Sección de chat añadida
                },
                { 
                    id: 'herr', 
                    name: 'Herramientas Tecnológicas', 
                    professor: 'Profesora Yamani', 
                    tasks: [], // Tareas vaciadas
                    messages: [] // Sección de chat añadida
                },
            ],
            globalAnnouncements: [
                // Texto del anuncio actualizado
                { id: 'a1', text: 'SE INICIA EL SEGUNDO BLOQUE DEL NOVENO CUATRIMESTRE REVISA TUS MATERIAS Y REALIZA TUS TAREAS EN TIEMPO Y FORMA' }
            ]
        };

        const appContainer = document.getElementById('app-container');
        const modalContainer = document.getElementById('modal-container');
        const notificationModal = document.getElementById('notification-modal');
        const notificationTitle = document.getElementById('notification-title');
        const notificationMessage = document.getElementById('notification-message');

        // --- FUNCIONES DE RENDERIZADO ---

        /**
         * Renderiza la aplicación completa basado en el estado
         */
        function renderApp() {
            // Limpiar contenedores
            appContainer.innerHTML = '';
            modalContainer.innerHTML = '';

            // Renderizar header
            appContainer.innerHTML += renderHeader();

            // Renderizar vista actual
            const mainContent = document.createElement('main');
            mainContent.className = 'p-4 max-w-5xl mx-auto';
            
            // Lógica de pestañas para Dashboard y Calificaciones
            if (appState.currentView === 'dashboard' || appState.currentView === 'grades') {
                mainContent.innerHTML = renderNavigationTabs(); // Pestañas
                if (appState.currentView === 'dashboard') {
                    mainContent.innerHTML += renderDashboard();
                } else {
                    mainContent.innerHTML += renderGradesView(); // Nueva vista
                }
            } else if (appState.currentView === 'subject') {
                mainContent.innerHTML = renderSubjectView();
            } else if (appState.currentView === 'task') {
                mainContent.innerHTML = renderTaskView();
            }
            
            appContainer.appendChild(mainContent);

            // Renderizar modales (siempre están en el DOM, pero ocultos)
            modalContainer.innerHTML = renderModals();
            
            // Scroll al final del chat si la vista es 'subject'
            if (appState.currentView === 'subject') {
                setTimeout(() => {
                    const chatWindow = document.getElementById('chat-window');
                    if (chatWindow) {
                        chatWindow.scrollTop = chatWindow.scrollHeight;
                    }
                }, 0);
            }
        }

        /**
         * Renderiza el encabezado
         */
        function renderHeader() {
            const isProfessor = appState.mode === 'professor';
            return `
                <header class="bg-rose-600 shadow-md p-4">
                    <div class="max-w-5xl mx-auto flex justify-between items-center">
                        <h1 class="text-xl sm:text-2xl font-bold text-white">UPTEX</h1>
                        <div class="flex items-center space-x-2">
                            <!-- Etiqueta de texto eliminada -->
                            <label for="mode-toggle" class="flex items-center cursor-pointer">
                                <div class="relative">
                                    <input type="checkbox" id="mode-toggle" class="sr-only" ${isProfessor ? 'checked' : ''} data-action="toggle-mode">
                                    <div class="toggle-bg block bg-gray-300 w-7 h-4 rounded-full transition-colors"></div>
                                </div>
                            </label>
                        </div>
                    </div>
                </header>
            `;
        }

        /**
         * Renderiza las pestañas de navegación principal (Materias y Calificaciones)
         */
        function renderNavigationTabs() {
            const isDashboard = appState.currentView === 'dashboard';
            const isGrades = appState.currentView === 'grades';

            // Clases para estilo de pestañas activas e inactivas
            const activeClass = 'border-rose-500 text-rose-600';
            const inactiveClass = 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';

            return `
                <div class="mb-6 border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button data-action="view-dashboard-main" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${isDashboard ? activeClass : inactiveClass}">
                            Mis Materias
                        </button>
                        <button data-action="view-grades" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${isGrades ? activeClass : inactiveClass}">
                            Calificaciones
                        </button>
                    </nav>
                </div>
            `;
        }


        /**
         * Renderiza el Dashboard (Anuncios y Materias)
         */
        function renderDashboard() {
            const isProfessor = appState.mode === 'professor';

            // HTML para Anuncios
            let announcementsHtml = appState.globalAnnouncements.map(ann => `
                <div class="bg-rose-100 border-l-4 border-rose-400 text-rose-800 p-4 rounded-r-lg mb-3">
                    <p class="text-sm">${ann.text}</p>
                </div>
            `).join('');

            if (appState.globalAnnouncements.length === 0) {
                announcementsHtml = `<p class="text-sm text-gray-500 italic">No hay anuncios por el momento.</p>`;
            }

            // HTML para Materias
            let subjectsHtml = appState.subjects.map(sub => {
                const isLocked = sub.id === 'com' || sub.id === 'ges';
                
                if (isLocked) {
                    // Plantilla para materias bloqueadas
                    return `
                    <div class="bg-gray-200 rounded-lg shadow p-4 opacity-70 cursor-not-allowed">
                        <h3 class="text-lg font-semibold text-gray-500 truncate">${sub.name}</h3>
                        <p class="text-sm text-gray-400">${sub.professor}</p>
                        <div class="mt-2 flex justify-between items-center">
                            <span class="text-xs font-medium text-gray-600 bg-gray-300 px-2 py-0.5 rounded-full">Bloqueado</span>
                            <!-- Calificación añadida a materias bloqueadas -->
                            <span class="text-sm font-semibold text-green-600">Calificación: 9</span>
                        </div>
                    </div>
                    `;
                } else {
                    // Plantilla para materias activas (con calificación)
                    return `
                    <div data-action="view-subject" data-id="${sub.id}" class="bg-white rounded-lg shadow p-4 cursor-pointer transition duration-300 hover:shadow-lg hover:ring-2 hover:ring-rose-400">
                        <h3 class="text-lg font-semibold text-rose-700 truncate">${sub.name}</h3>
                        <p class="text-sm text-gray-600">${sub.professor}</p>
                        <div class="mt-2 flex justify-between items-center">
                            <span class="text-xs font-medium text-rose-600 bg-rose-100 px-2 py-0.5 rounded-full">${sub.tasks.length} tareas</span>
                            <!-- Calificación eliminada de materias activas -->
                        </div>
                    </div>
                    `;
                }
            }).join('');

            return `
                <!-- Sección de Anuncios -->
                <section class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <!-- Título de Anuncios actualizado -->
                        <h2 class="text-xl font-semibold text-rose-800">Anuncios</h2>
                        ${isProfessor ? `
                            <button data-action="open-modal" data-modal-id="globalAnnouncementModal" class="bg-rose-500 text-white px-3 py-1 rounded-lg text-xs font-medium shadow hover:bg-rose-600 transition-colors">
                                + Anuncio
                            </button>
                        ` : ''}
                    </div>
                    <div class="bg-white rounded-lg shadow p-4">
                        ${announcementsHtml}
                    </div>
                </section>

                <!-- Sección de Materias -->
                <section>
                    <h2 class="text-xl font-semibold text-rose-800 mb-3">Mis Materias</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${subjectsHtml}
                    </div>
                </section>
            `;
        }

        /**
         * Renderiza la vista de Calificaciones
         */
        function renderGradesView() {
            const isProfessor = appState.mode === 'professor';
            
            // 1. Recopilar todas las tareas de todas las materias
            let allTasks = [];
            appState.subjects.forEach(sub => {
                // No incluir tareas de materias bloqueadas
                if (sub.id !== 'com' && sub.id !== 'ges') {
                    sub.tasks.forEach(task => {
                        allTasks.push({
                            ...task,
                            subjectName: sub.name,
                            subjectId: sub.id
                        });
                    });
                }
            });

            // 2. Filtrar solo las tareas entregadas
            const submittedTasks = allTasks.filter(t => t.submission.submitted);

            if (submittedTasks.length === 0) {
                const message = isProfessor ? "Aún no hay tareas entregadas para calificar." : "Aún no has entregado tareas.";
                return `
                    <h2 class="text-xl font-semibold text-rose-800 mb-3">Calificaciones</h2>
                    <p class="text-sm text-gray-500 italic">${message}</p>
                `;
            }

            // 3. Renderizar la lista
            let tasksHtml = submittedTasks.map(task => {
                const grade = task.submission.grade;
                const status = grade ? 
                    `<span class="text-sm font-bold text-green-600">${grade}</span>` : 
                    `<span class="text-sm font-medium text-blue-600">Entregada</span>`;
                
                const professorButton = isProfessor ? `
                    <button data-action="open-grade-modal-from-list" data-subject-id="${task.subjectId}" data-task-id="${task.id}" class="bg-rose-500 text-white px-3 py-1 rounded-lg text-xs font-medium shadow hover:bg-rose-600 transition-colors">
                        ${grade ? 'Modificar' : 'Calificar'}
                    </button>
                ` : '';

                return `
                    <li class="bg-white rounded-lg shadow p-4 flex justify-between items-center">
                        <div>
                            <h4 class="text-md font-semibold text-rose-700">${task.title}</h4>
                            <p class="text-sm text-gray-600">${task.subjectName}</p>
                        </div>
                        <div class="text-right flex items-center space-x-4">
                            <div class="flex flex-col items-end">
                                <span class="text-xs text-gray-500 mb-1">Calificación</span>
                                ${status}
                            </div>
                            ${professorButton}
                        </div>
                    </li>
                `;
            }).join('');

            return `
                <h2 class="text-xl font-semibold text-rose-800 mb-3">Calificaciones</h2>
                <ul class="space-y-3">
                    ${tasksHtml}
                </ul>
            `;
        }

        /**
         * Renderiza la vista de una Materia (Tareas)
         */
        function renderSubjectView() {
            const isProfessor = appState.mode === 'professor';
            const subject = appState.subjects.find(s => s.id === appState.currentSubjectId);

            if (!subject) return `<p>Materia no encontrada.</p>`;

            // Renderizado de Tareas
            let tasksHtml = subject.tasks.map(task => {
                let taskStatus = '';
                if (isProfessor) {
                    if (task.submission?.submitted) {
                        taskStatus = task.submission.grade 
                            ? `<span class="text-xs text-green-600 font-medium">Calificada</span>` 
                            : `<span class="text-xs text-blue-600 font-medium">Entregada</span>`;
                    } else {
                        taskStatus = `<span class="text-xs text-gray-500 font-medium">Pendiente</span>`;
                    }
                } else {
                     if (task.submission?.submitted) {
                        taskStatus = task.submission.grade 
                            ? `<span class="text-xs text-green-600 font-medium">Calificada (${task.submission.grade})</span>` 
                            : `<span class="text-xs text-blue-600 font-medium">Entregada</span>`;
                    }
                }

                return `
                <div data-action="view-task" data-subject-id="${subject.id}" data-task-id="${task.id}" class="bg-white rounded-lg shadow p-4 flex justify-between items-center cursor-pointer transition duration-300 hover:shadow-md hover:bg-gray-50">
                    <div>
                        <h4 class="text-md font-semibold text-rose-700">${task.title}</h4>
                        <p class="text-sm text-gray-600 truncate">${task.description}</p>
                    </div>
                    <div class="text-right">
                        ${taskStatus}
                        <span class="text-sm text-gray-400 ml-2">&gt;</span>
                    </div>
                </div>
                `;
            }).join('');

            if (subject.tasks.length === 0) {
                tasksHtml = `<p class="text-sm text-gray-500 italic">No hay tareas asignadas para esta materia.</p>`;
            }

            // Renderizado de Mensajes
            let messagesHtml = (subject.messages || []).map(msg => {
                const isProfessorMsg = msg.by === 'professor';
                return `
                    <div class="flex ${isProfessorMsg ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[70%] p-3 rounded-lg ${isProfessorMsg ? 'bg-rose-100 text-rose-900' : 'bg-gray-200 text-gray-900'}">
                            <p class="text-sm">${msg.text}</p>
                        </div>
                    </div>
                `;
            }).join('');

            if ((subject.messages || []).length === 0) {
                messagesHtml = `<p class="text-sm text-gray-400 italic text-center">No hay mensajes.</p>`;
            }

            return `
                <button data-action="view-dashboard-main" class="text-sm text-rose-500 hover:underline mb-4">&larr; Volver a Materias</button>
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-rose-800">${subject.name}</h2>
                        <p class="text-md text-gray-600">${subject.professor}</p>
                    </div>
                </div>

                <!-- Sección de Tareas -->
                <section>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl font-semibold text-rose-800">Tareas</h3>
                        ${isProfessor ? `
                            <button data-action="open-modal" data-modal-id="taskModal" class="bg-rose-500 text-white px-3 py-1 rounded-lg text-xs font-medium shadow hover:bg-rose-600 transition-colors">
                                + Tarea
                            </button>
                        ` : ''}
                    </div>
                    <div class="space-y-3">
                        ${tasksHtml}
                    </div>
                </section>
                
                <!-- Sección de Mensajes (Chat) -->
                <section class="mt-8">
                    <h3 class="text-xl font-semibold text-rose-800 mb-3">Mensajes de la Materia</h3>
                    <!-- Ventana de Chat -->
                    <div id="chat-window" class="bg-white rounded-lg shadow p-4 h-64 overflow-y-auto space-y-3 no-scrollbar">
                        ${messagesHtml}
                    </div>
                    <!-- Formulario de Envío -->
                    <form id="subject-message-form" class="mt-4 flex space-x-2">
                        <input id="subject-message-text" type="text" placeholder="Escribe un mensaje..." class="flex-1 border border-gray-300 rounded-lg p-2 text-sm">
                        <button data-action="send-subject-message" type="button" class="bg-rose-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow hover:bg-rose-600">
                            Enviar
                        </button>
                    </form>
                </section>
            `;
        }

        /**
         * Renderiza la vista de una Tarea (Descripción y Comentarios)
         */
        function renderTaskView() {
            const isProfessor = appState.mode === 'professor';
            const subject = appState.subjects.find(s => s.id === appState.currentSubjectId);
            const task = subject?.tasks.find(t => t.id === appState.currentTaskId);

            if (!task) return `<p>Tarea no encontrada.</p>`;

            // Renderizar comentarios generales
            let commentsHtml = (task.comments || []).map(comment => `
                <div class="p-3 rounded-lg ${comment.by === 'professor' ? 'bg-rose-100 text-rose-800' : 'bg-gray-100 text-gray-800'}">
                    <span class="font-bold text-sm capitalize">${comment.by === 'professor' ? 'Profesor' : 'Tú'}</span>
                    <p class="text-sm">${comment.text}</p>
                </div>
            `).join('');

            // Renderizar sección de entrega (Alumno)
            let submissionHtml = '';
            if (!isProfessor) {
                const sub = task.submission;
                if (!sub.submitted) {
                    submissionHtml = `
                        <div class="flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0">
                            <button data-action="open-modal" data-modal-id="submitTaskModal" class="flex-1 bg-rose-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow hover:bg-rose-600 transition-colors">
                                Entregar Tarea
                            </button>
                            <button data-action="open-modal" data-modal-id="sendMessageModal" class="flex-1 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300 transition-colors">
                                Enviar Mensaje a Profesor
                            </button>
                        </div>
                    `;
                } else {
                    submissionHtml = `
                        <h4 class="text-md font-semibold text-gray-700 mb-3">Tu Entrega</h4>
                        <div class="bg-gray-100 p-4 rounded-lg space-y-3">
                            <div>
                                <span class="text-sm font-medium text-gray-600">Estado:</span>
                                <span class="text-sm text-blue-600 font-semibold ml-2">Entregada</span>
                            </div>
                            ${sub.grade ? `
                            <div>
                                <span class="text-sm font-medium text-gray-600">Calificación:</span>
                                <span class="text-sm text-black font-bold ml-2">${sub.grade}</span>
                            </div>
                            ` : ''}
                            ${sub.feedback ? `
                            <div>
                                <span class="text-sm font-medium text-gray-600 d-block mb-1">Retroalimentación del Profesor:</span>
                                <p class="text-sm text-gray-800 bg-white p-3 rounded-md mt-1">${sub.feedback}</p>
                            </div>
                            ` : ''}
                            ${!sub.grade ? `
                            <p class="text-sm text-gray-500 italic">Tu tarea está pendiente de calificación.</p>
                            ` : ''}
                        </div>
                        <button data-action="open-modal" data-modal-id="sendMessageModal" class="mt-4 w-full bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300 transition-colors">
                            Enviar Mensaje a Profesor
                        </button>
                    `;
                }
            }

            // Renderizar sección de entrega (Profesor)
            let gradingHtml = '';
            if (isProfessor) {
                const sub = task.submission;
                gradingHtml = `
                    <section class="mt-6">
                        <h3 class="text-xl font-semibold text-rose-800 mb-3">Entrega del Alumno</h3>
                        ${!sub.submitted ? `
                            <p class="text-sm text-gray-500 italic">El alumno aún no ha entregado esta tarea.</p>
                        ` : `
                            <div class="bg-white rounded-lg shadow p-4">
                                <span class="text-sm text-blue-600 font-semibold">El alumno ha entregado la tarea.</span>
                                ${sub.grade ? `
                                    <div class="mt-3">
                                        <p class="text-sm font-medium text-gray-600">Calificación Asignada: <span class="text-black font-bold">${sub.grade}</span></p>
                                        <p class="text-sm font-medium text-gray-600 mt-1">Comentario:</p>
                                        <p class="text-sm text-gray-800 bg-gray-100 p-2 rounded-md mt-1">${sub.feedback}</p>
                                    </div>
                                    <button data-action="open-grade-modal" class="mt-3 bg-rose-500 text-white px-3 py-1 rounded-lg text-xs font-medium shadow hover:bg-rose-600 transition-colors">
                                        Modificar Calificación
                                    </button>
                                ` : `
                                    <button data-action="open-grade-modal" class="mt-3 bg-green-500 text-white px-3 py-1 rounded-lg text-xs font-medium shadow hover:bg-green-600 transition-colors">
                                        Asignar Calificación
                                    </button>
                                `}
                            </div>
                        `}
                    </section>
                `;
            }

            return `
                <button data-action="back-subject" class="text-sm text-rose-500 hover:underline mb-4">&larr; Volver a ${subject.name}</button>
                
                <!-- Descripción de Tarea -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-2xl font-bold text-rose-800 mb-2">${task.title}</h2>
                    <p class="text-gray-700 mb-6">${task.description}</p>
                    
                    <!-- Contenido dinámico (Entrega Alumno / Calificación Profesor) -->
                    ${!isProfessor ? submissionHtml : ''}
                </div>

                <!-- Sección de Comentarios/Anuncios de Tarea -->
                <section>
                    <h3 class="text-xl font-semibold text-rose-800 mb-3">${isProfessor ? 'Comentarios y Anuncios' : 'Comentarios del Profesor'}</h3>
                    
                    ${isProfessor ? `
                        <!-- Formulario de Profesor para agregar comentario -->
                        <form id="comment-form" class="mb-4">
                            <textarea id="comment-text" class="w-full border border-gray-300 rounded-lg p-2 text-sm" rows="3" placeholder="Escribir un comentario o anuncio para esta tarea..."></textarea>
                            <button data-action="add-comment" type="button" class="mt-2 bg-rose-500 text-white px-4 py-1 rounded-lg text-xs font-medium shadow hover:bg-rose-600 transition-colors">
                                Publicar
                            </button>
                        </form>
                    ` : ''}

                    <!-- Lista de Comentarios -->
                    <div class="space-y-3">
                        ${commentsHtml}
                        ${(task.comments || []).length === 0 ? `<p class="text-sm text-gray-500 italic">No hay comentarios.</p>` : ''}
                    </div>
                </section>
                
                <!-- Sección de Calificación (Solo Profesor) -->
                ${gradingHtml}
            `;
        }

        /**
         * Renderiza todos los modales (ocultos por defecto)
         */
        function renderModals() {
            // Esta función ahora usa el estado global, por lo que funciona desde cualquier vista
            const task = appState.subjects.find(s => s.id === appState.currentSubjectId)?.tasks.find(t => t.id === appState.currentTaskId);
            const currentGrade = task?.submission?.grade || '';
            const currentFeedback = task?.submission?.feedback || '';

            return `
                <!-- Modal: Agregar Anuncio Global -->
                <div id="globalAnnouncementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-md">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Nuevo Anuncio</h3>
                        <textarea id="global-announcement-text" class="w-full border border-gray-300 rounded-lg p-2 text-sm" rows="4" placeholder="Escribe tu anuncio..."></textarea>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button data-action="close-modal" data-modal-id="globalAnnouncementModal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300">Cancelar</button>
                            <button data-action="add-global-announcement" class="bg-rose-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow hover:bg-rose-600">Publicar</button>
                        </div>
                    </div>
                </div>

                <!-- Modal: Agregar Tarea -->
                <div id="taskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-md">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Nueva Tarea</h3>
                        <div class="space-y-3">
                            <input id="task-title" type="text" placeholder="Título de la tarea" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                            <textarea id="task-description" class="w-full border border-gray-300 rounded-lg p-2 text-sm" rows="4" placeholder="Descripción de la tarea..."></textarea>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button data-action="close-modal" data-modal-id="taskModal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300">Cancelar</button>
                            <button data-action="add-task" class="bg-rose-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow hover:bg-rose-600">Crear Tarea</button>
                        </div>
                    </div>
                </div>

                <!-- Modal: Entrega de Tarea (Alumno) -->
                <div id="submitTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-md">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Entregar Tarea</h3>
                        <p class="text-sm text-gray-600 mb-4">Sube tu archivo para completar la entrega.</p>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" class="text-sm">
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button data-action="close-modal" data-modal-id="submitTaskModal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300">Cancelar</button>
                            <button data-action="submit-task" class="bg-rose-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow hover:bg-rose-600">Entregar</button>
                        </div>
                    </div>
                </div>

                <!-- Modal: Enviar Mensaje (Alumno) -->
                <div id="sendMessageModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-md">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Enviar Mensaje al Profesor</h3>
                        <textarea id="message-text" class="w-full border border-gray-300 rounded-lg p-2 text-sm" rows="5" placeholder="Escribe tu mensaje privado..."></textarea>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button data-action="close-modal" data-modal-id="sendMessageModal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300">Cancelar</button>
                            <button data-action="send-message" class="bg-rose-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow hover:bg-rose-600">Enviar</button>
                        </div>
                    </div>
                </div>
                
                <!-- Modal: Calificar Tarea (Profesor) -->
                <div id="gradeTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-md">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Calificar Tarea</h3>
                        <div class="space-y-3">
                            <input id="grade-value" type="text" placeholder="Calificación (Ej: 9.5)" value="${currentGrade}" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                            <textarea id="grade-feedback" class="w-full border border-gray-300 rounded-lg p-2 text-sm" rows="4" placeholder="Escribe la retroalimentación...">${currentFeedback}</textarea>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button data-action="close-modal" data-modal-id="gradeTaskModal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300">Cancelar</button>
                            <button data-action="save-grade" class="bg-rose-500 text-white px-4 py-2 rounded-lg text-sm font-medium shadow hover:bg-rose-600">Guardar Calificación</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- FUNCIONES DE LÓGICA Y EVENTOS ---

        function showView(view, subjectId = null, taskId = null) {
            appState.currentView = view;
            appState.currentSubjectId = subjectId;
            appState.currentTaskId = taskId;
            
            // Limpiar IDs si volvemos a las vistas principales
            if (view === 'dashboard' || view === 'grades') {
                appState.currentSubjectId = null;
                appState.currentTaskId = null;
            }
            
            renderApp();
            window.scrollTo(0, 0); // Regresar al top
        }

        function openModal(modalId) {
            // Re-renderizar modales para asegurar que los datos (ej. calificación) estén actualizados
            modalContainer.innerHTML = renderModals();
            document.getElementById(modalId)?.classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId)?.classList.add('hidden');
        }

        function showNotification(title, message) {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            notificationModal.classList.remove('hidden');
        }

        function handleToggleMode(e) {
            appState.mode = e.target.checked ? 'professor' : 'student';
            // Resetear la vista al cambiar de modo
            showView('dashboard');
        }

        function handleAddGlobalAnnouncement() {
            const text = document.getElementById('global-announcement-text').value;
            if (text.trim()) {
                appState.globalAnnouncements.unshift({
                    id: `a${Date.now()}`,
                    text: text.trim()
                });
                document.getElementById('global-announcement-text').value = '';
                closeModal('globalAnnouncementModal');
                showView('dashboard'); // Re-renderiza el dashboard
            }
        }

        function handleAddTask() {
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const subject = appState.subjects.find(s => s.id === appState.currentSubjectId);

            if (title.trim() && description.trim() && subject) {
                subject.tasks.push({
                    id: `t${Date.now()}`,
                    title: title.trim(),
                    description: description.trim(),
                    comments: [],
                    submission: { submitted: false, grade: null, feedback: null } // Asegurar que la nueva tarea tenga esto
                });
                document.getElementById('task-title').value = '';
                document.getElementById('task-description').value = '';
                closeModal('taskModal');
                renderApp(); // Re-renderiza la vista de materia
            }
        }
        
        function handleAddComment() {
            const text = document.getElementById('comment-text').value;
            const subject = appState.subjects.find(s => s.id === appState.currentSubjectId);
            const task = subject?.tasks.find(t => t.id === appState.currentTaskId);

            if (text.trim() && task) {
                if (!task.comments) {
                    task.comments = [];
                }
                task.comments.push({
                    by: 'professor',
                    text: text.trim()
                });
                document.getElementById('comment-text').value = '';
                renderApp(); // Re-renderiza la vista de tarea
            }
        }

        function handleSubmitTask() {
            const task = appState.subjects
                .find(s => s.id === appState.currentSubjectId)?.tasks
                .find(t => t.id === appState.currentTaskId);
            
            if (task) {
                task.submission.submitted = true;
            }
            
            closeModal('submitTaskModal');
            showNotification('¡Tarea Entregada!', 'Tu tarea ha sido enviada.');
            renderApp(); // Re-renderizar para mostrar estado "Entregada"
        }

        function handleSendMessage() {
            const text = document.getElementById('message-text').value;
            if (text.trim()) {
                document.getElementById('message-text').value = '';
                closeModal('sendMessageModal');
                showNotification('¡Mensaje Enviado!', 'Tu mensaje ha sido enviado al profesor.');
            }
        }
        
        /**
         * Maneja el envío de un mensaje en el chat de la materia
         */
        function handleSendSubjectMessage() {
            const text = document.getElementById('subject-message-text').value;
            const subject = appState.subjects.find(s => s.id === appState.currentSubjectId);

            if (text.trim() && subject) {
                if (!subject.messages) {
                    subject.messages = [];
                }
                subject.messages.push({
                    by: appState.mode, // 'professor' o 'student'
                    text: text.trim()
                });
                document.getElementById('subject-message-text').value = '';
                renderApp(); // Re-renderiza la vista de materia
            }
        }

        function handleSaveGrade() {
            const grade = document.getElementById('grade-value').value;
            const feedback = document.getElementById('grade-feedback').value;
            
            const task = appState.subjects
                .find(s => s.id === appState.currentSubjectId)?.tasks
                .find(t => t.id === appState.currentTaskId);

            if (task && grade.trim()) {
                task.submission.grade = grade;
                task.submission.feedback = feedback.trim() || 'Sin comentarios.';
                
                closeModal('gradeTaskModal');
                showNotification('¡Calificación Guardada!', 'La calificación ha sido asignada al alumno.');
                renderApp(); // Re-renderizar para mostrar la calificación
            } else {
                 showNotification('Error', 'Debes ingresar al menos una calificación.');
            }
        }


        // --- MANEJADOR PRINCIPAL DE EVENTOS (DELEGACIÓN) ---

        document.body.addEventListener('click', function(e) {
            // Usar 'closest' para encontrar el elemento con data-action
            const target = e.target.closest('[data-action]');
            if (!target) return;

            // Prevenir clics en elementos dentro de un contenedor bloqueado
            if (target.closest('.cursor-not-allowed')) {
                return;
            }

            const action = target.dataset.action;
            const modalId = target.dataset.modalId;

            switch (action) {
                case 'toggle-mode':
                    handleToggleMode(e);
                    break;
                // Acciones de pestañas principales
                case 'view-dashboard-main':
                    showView('dashboard');
                    break;
                case 'view-grades':
                    showView('grades');
                    break;
                // Acciones de navegación
                case 'view-subject':
                    showView('subject', target.dataset.id);
                    break;
                case 'view-task':
                    showView('task', target.dataset.subjectId, target.dataset.taskId);
                    break;
                case 'back-dashboard':
                    showView('dashboard');
                    break;
                case 'back-subject':
                    showView('subject', appState.currentSubjectId);
                    break;
                // Acciones de Modales
                case 'open-modal':
                    openModal(modalId);
                    break;
                case 'open-grade-modal': // Desde la vista de tarea
                    openModal('gradeTaskModal');
                    break;
                case 'open-grade-modal-from-list': // Desde la nueva vista de calificaciones
                    // Guardar el contexto de la tarea a calificar
                    appState.currentSubjectId = target.dataset.subjectId;
                    appState.currentTaskId = target.dataset.taskId;
                    openModal('gradeTaskModal');
                    break;
                case 'close-modal':
                    closeModal(modalId);
                    break;
                case 'close-notification':
                    notificationModal.classList.add('hidden');
                    break;
                // Acciones de Lógica
                case 'add-global-announcement':
                    handleAddGlobalAnnouncement();
                    break;
                case 'add-task':
                    handleAddTask();
                    break;
                case 'add-comment':
                    handleAddComment();
                    break;
                case 'submit-task':
                    handleSubmitTask();
                    break;
                case 'send-message':
                    handleSendMessage();
                    break;
                case 'send-subject-message': // Nueva acción
                    handleSendSubjectMessage();
                    break;
                case 'save-grade':
                    handleSaveGrade();
                    break;
            }
        });

        // --- INICIALIZACIÓN ---
        renderApp();

    </script>
</body>
</html>
